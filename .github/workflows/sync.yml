name: Auto Sync Text4567

on:
  # å®šæ—¶è§¦å‘ï¼šåŒ—äº¬æ—¶é—´ 8:00ã€20:00 æ£€æŸ¥
  schedule:
    - cron: '0 0 * * *'    # UTC 0:00 (åŒ—äº¬æ—¶é—´ 8:00)
    - cron: '0 12 * * *'   # UTC 12:00 (åŒ—äº¬æ—¶é—´ 20:00)
  
  # å…è®¸æ‰‹åŠ¨åœ¨ GitHub ç½‘é¡µä¸Šç‚¹å‡»è¿è¡Œ
  workflow_dispatch:
  
  # å½“ä½ çš„ä»“åº“æœ‰ push æ—¶ä¹Ÿæ£€æŸ¥åŒæ­¥ï¼ˆå¯é€‰ï¼‰
  push:
    branches: [ main ]

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
    # æ­¥éª¤1: æ£€å‡ºå½“å‰ä»“åº“
    - name: Checkout your repository
      uses: actions/checkout@v4
      with:
        # ä½¿ç”¨ä½ çš„ PAT ä»¥ä¾¿æ¨é€
        token: ${{ secrets.GH_PAT }}
        fetch-depth: 0  # è·å–å®Œæ•´å†å²

    # æ­¥éª¤2: é…ç½® Git ç”¨æˆ·ä¿¡æ¯
    - name: Configure Git
      run: |
        git config --global user.name "Auto Sync Bot"
        git config --global user.email "1137843689@qq.com"
        git config --global pull.rebase false

    # æ­¥éª¤3: æ£€æŸ¥ç›®æ ‡ä»“åº“æ˜¯å¦æœ‰24å°æ—¶å†…çš„æäº¤
    - name: Check for recent commits in snowonfiner/text4567
      id: check_commits
      run: |
        echo "æ£€æŸ¥ snowonfiner/text4567 æ˜¯å¦æœ‰24å°æ—¶å†…çš„æäº¤..."
        
        # ä½¿ç”¨ GitHub API æ£€æŸ¥æœ€æ–°æäº¤
        response=$(curl -s \
          -H "Accept: application/vnd.github.v3+json" \
          "https://api.github.com/repos/snowonfiner/text4567/commits?per_page=1")
        
        if echo "$response" | grep -q "Not Found"; then
          echo "é”™è¯¯: æ‰¾ä¸åˆ°ä»“åº“ snowonfiner/text4567"
          echo "has_recent_commits=false" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        # è·å–æœ€æ–°æäº¤æ—¶é—´
        latest_commit_time=$(echo "$response" | grep -o '"date":"[^"]*"' | head -1 | cut -d'"' -f4)
        
        if [ -z "$latest_commit_time" ]; then
          echo "æ— æ³•è·å–æäº¤æ—¶é—´"
          echo "has_recent_commits=false" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        # è½¬æ¢ä¸ºæ—¶é—´æˆ³å¹¶è®¡ç®—æ—¶é—´å·®
        latest_timestamp=$(date -d "$latest_commit_time" +%s 2>/dev/null || date -j -f "%Y-%m-%dT%H:%M:%SZ" "$latest_commit_time" +%s 2>/dev/null)
        current_timestamp=$(date +%s)
        hours_diff=$(( (current_timestamp - latest_timestamp) / 3600 ))
        
        echo "æœ€æ–°æäº¤æ—¶é—´: $latest_commit_time"
        echo "è·ç¦»ç°åœ¨: $hours_diff å°æ—¶å‰"
        
        # å¦‚æœ24å°æ—¶å†…æœ‰æäº¤
        if [ $hours_diff -lt 24 ]; then
          echo "âœ… å‘ç° $hours_diff å°æ—¶å‰çš„æ–°æäº¤ï¼Œå‡†å¤‡åŒæ­¥"
          echo "has_recent_commits=true" >> $GITHUB_OUTPUT
          echo "hours_ago=$hours_diff" >> $GITHUB_OUTPUT
        else
          echo "âŒ æ²¡æœ‰24å°æ—¶å†…çš„æ–°æäº¤ï¼ˆæœ€è¿‘ä¸€æ¬¡æ˜¯ $hours_diff å°æ—¶å‰ï¼‰"
          echo "has_recent_commits=false" >> $GITHUB_OUTPUT
        fi

    # æ­¥éª¤4: ä¸‹è½½ text4567 çš„ ZIP æ–‡ä»¶ï¼ˆå¦‚æœæœ‰æ–°æäº¤ï¼‰
    - name: Download text4567 ZIP
      if: steps.check_commits.outputs.has_recent_commits == 'true'
      run: |
        echo "æ­£åœ¨ä¸‹è½½ snowonfiner/text4567 çš„æœ€æ–°ä»£ç ..."
        
        # ä¸‹è½½ main åˆ†æ”¯çš„ ZIP
        curl -L -o text4567_latest.zip \
          "https://github.com/snowonfiner/text4567/archive/refs/heads/main.zip"
        
        # æ£€æŸ¥æ–‡ä»¶å¤§å°
        file_size=$(stat -c%s text4567_latest.zip 2>/dev/null || stat -f%z text4567_latest.zip 2>/dev/null)
        echo "ä¸‹è½½å®Œæˆï¼Œæ–‡ä»¶å¤§å°: $((file_size / 1024)) KB"
        
        if [ $file_size -lt 100 ]; then
          echo "é”™è¯¯: ä¸‹è½½çš„æ–‡ä»¶å¤ªå°ï¼Œå¯èƒ½å¤±è´¥"
          exit 1
        fi

    # æ­¥éª¤5: è§£å‹å¹¶è¦†ç›–æ–‡ä»¶
    - name: Extract and overwrite files
      if: steps.check_commits.outputs.has_recent_commits == 'true'
      run: |
        echo "è§£å‹æ–‡ä»¶å¹¶è¦†ç›–æœ¬åœ°..."
        
        # åˆ›å»ºä¸´æ—¶ç›®å½•
        mkdir -p temp_extract
        
        # è§£å‹ ZIP
        unzip -q text4567_latest.zip -d temp_extract
        
        # è¿›å…¥è§£å‹åçš„ç›®å½•
        cd temp_extract/text4567-main
        
        # å¤åˆ¶æ‰€æœ‰æ–‡ä»¶åˆ°å·¥ä½œç›®å½•ï¼ˆæ’é™¤ .git ç›®å½•ï¼‰
        echo "å¤åˆ¶æ–‡ä»¶..."
        find . -type f -not -path "*/.git/*" -not -name ".git*" | while read file; do
          # ç¡®ä¿ç›®æ ‡ç›®å½•å­˜åœ¨
          mkdir -p "${{ github.workspace }}/$(dirname "$file")"
          # å¤åˆ¶æ–‡ä»¶
          cp -f "$file" "${{ github.workspace }}/$file"
        done
        
        # å›åˆ°å·¥ä½œç›®å½•
        cd "${{ github.workspace }}"
        
        # åˆ—å‡ºå·²æ›´æ–°çš„æ–‡ä»¶
        echo "å·²æ›´æ–°çš„æ–‡ä»¶ï¼š"
        git status --porcelain | head -20

    # æ­¥éª¤6: æäº¤æ›´æ”¹åˆ°ä½ çš„ä»“åº“
    - name: Commit and push changes
      if: steps.check_commits.outputs.has_recent_commits == 'true'
      run: |
        echo "æäº¤æ›´æ”¹åˆ°ä½ çš„ä»“åº“..."
        
        # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶æ›´æ”¹
        if git diff --quiet && git diff --cached --quiet; then
          echo "æ²¡æœ‰æ£€æµ‹åˆ°æ–‡ä»¶æ›´æ”¹"
          exit 0
        fi
        
        # æ·»åŠ æ‰€æœ‰æ›´æ”¹
        git add .
        
        # æäº¤
        git commit -m "ğŸ”„ è‡ªåŠ¨åŒæ­¥ snowonfiner/text4567 (${{ steps.check_commits.outputs.hours_ago }}å°æ—¶å‰æœ‰æ›´æ–°) - $(date +'%Y-%m-%d %H:%M:%S')"
        
        # æ¨é€
        git push origin main
        
        echo "âœ… åŒæ­¥å®Œæˆå¹¶å·²æ¨é€"

    # æ­¥éª¤7: æ¸…ç†ä¸´æ—¶æ–‡ä»¶
    - name: Cleanup
      if: always()
      run: |
        echo "æ¸…ç†ä¸´æ—¶æ–‡ä»¶..."
        rm -f text4567_latest.zip
        rm -rf temp_extract 2>/dev/null || true

    # æ­¥éª¤8: å¦‚æœæ²¡æœ‰æ–°æäº¤æ—¶çš„æ¶ˆæ¯
    - name: No updates notification
      if: steps.check_commits.outputs.has_recent_commits == 'false'
      run: |
        echo "ğŸ¯ æ£€æŸ¥å®Œæˆï¼šsnowonfiner/text4567 æ²¡æœ‰24å°æ—¶å†…çš„æ–°æäº¤"